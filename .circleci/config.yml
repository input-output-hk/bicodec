
version: 2
jobs:
  build:
    docker:
      - image: openjdk:8
    working_directory: ~/repo
    steps:
      - checkout

      - run:
          name: install coursier
          command: curl -L -o coursier https://git.io/vgvpD && chmod +x coursier

      - run:
          name: install scalafmt
          command: ./coursier bootstrap org.scalameta:scalafmt-cli_2.12:2.0.0-RC4 -r bintray:scalameta/maven -o scalafmt --main org.scalafmt.cli.Cli

      - run:
          name: install mill
          command: sh -c '(echo "#!/usr/bin/env sh" && curl -L https://github.com/lihaoyi/mill/releases/download/0.4.1/0.4.1) > /usr/local/bin/mill && chmod +x /usr/local/bin/mill'

      - run:
          name: install gpg2
          command: apt update && apt install -y gnupg2

      - run:
          name: install base64
          command: apt update && apt install -y cl-base64

      - run:
          name: test
          command: |
            mill all __.testLocal

      - run:
          name: check that the code is formatted properly
          command: ./scalafmt --test

      - run:
          name: publish to sonatype
          command: |
            set -eux

            echo "$gpgPrivateKey" | base64 --decode > gpg_key

            gpg2 --batch --passphrase "$gpgPassphrase" --import gpg_key

            rm gpg_key

            gpg2 --list-secret-keys

            echo "$otrust" > otrust.txt

            gpg2 --import-ownertrust otrust.txt

            gpg2 --list-secret-keys

            mill mill.scalalib.PublishModule/publishAll \
                "$username:$password" \
                "$gpgPassphrase" \
                __.publishArtifacts \
                --release \
                true